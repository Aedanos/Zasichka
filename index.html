<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Zasichka JS v1.3 (Compatibility Update)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #ffd700; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #video-section { flex: 1; background: #000; display: flex; flex-direction: column; }
        #player-container { width: 100%; flex-grow: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        iframe, video { width: 100%; height: 100%; border: none; }
        #sidebar { width: 380px; background: white; border-left: 2px solid #ddd; display: flex; flex-direction: column; padding: 15px; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.5rem; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        label { font-size: 11px; font-weight: bold; color: #666; display: block; margin-bottom: 4px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; font-size: 12px; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-main { background: var(--accent); grid-column: span 2; height: 50px; font-size: 16px; border: 2px solid #e6c300; }
        .btn-save { background: #ccffcc; }
        .btn-load { background: #d1e7ff; }
        .btn-reset { background: #eee; }
        .btn-delete { background: #ffcccc; }
        #table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; background: #fff; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 10px; border-bottom: 2px solid #ddd; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        tr:hover { background: #f0f7ff; cursor: pointer; }
        tr.active { background: #e3f2fd; font-weight: bold; }
        tr.opened { opacity: 0.6; }
        tr.opened td:nth-child(2) { text-decoration: line-through; color: #888; }
        .video-bar { padding: 12px; background: #1a1a1a; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

<div id="video-section">
    <div id="player-container"><div id="player-placeholder" style="color:white">Завантажте відео</div></div>
    <div class="video-bar">
        <input type="text" id="video-url" placeholder="Посилання на YouTube або файл...">
        <button onclick="handleSmartLoad()" style="background:white; color:black; min-width:100px;">ЗАВАНТАЖИТИ</button>
    </div>
</div>

<div id="sidebar">
    <div class="header-title" id="video-name-display">ЗАСІЧКА</div>
    <div class="settings-grid">
        <label>КОРЕКЦІЯ ЧАСУ (сек):</label>
        <input type="number" id="correction" value="0" step="0.1" onchange="renderTable()">
    </div>
    <div class="controls">
        <button class="btn-main" onclick="addLapFromPlayer()">ПОСТАВИТИ МІТКУ</button>
        <button class="btn-load" onclick="importSich()">ВІДКРИТИ .SICH</button>
        <button class="btn-save" onclick="exportSich()">ЗБЕРЕГТИ .SICH</button>
        <button class="btn-delete" onclick="deleteSelected()">ВИДАЛИТИ РЯДОК</button>
        <button class="btn-reset" onclick="resetAll()">ОЧИСТИТИ ВСЕ</button>
    </div>
    <div id="table-container">
        <table>
            <thead><tr><th>№</th><th>Час</th><th>Дія</th></tr></thead>
            <tbody id="laps-body"></tbody>
        </table>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let currentPlayer = { type: null, ref: null, title: "session" };
    let laps = [];
    let selectedIndex = null;

    function handleSmartLoad(url = null) {
        const input = url || document.getElementById('video-url').value.trim();
        if (!input) return;
        document.getElementById('video-url').value = input;
        document.getElementById('player-container').innerHTML = '<div id="player"></div>';
        
        const ytId = extractYouTubeID(input);
        if (ytId) {
            currentPlayer.type = 'youtube';
            currentPlayer.ref = new YT.Player('player', {
                height: '100%', width: '100%', videoId: ytId,
                events: { 'onReady': (e) => { 
                    currentPlayer.title = e.target.getVideoData().title || "youtube_video";
                    document.getElementById('video-name-display').innerText = currentPlayer.title;
                }}
            });
        } else if (input.match(/\.(mp4|webm|ogg)$/i)) {
            currentPlayer.type = 'direct';
            currentPlayer.title = input.split('/').pop().split('?')[0];
            document.getElementById('video-name-display').innerText = currentPlayer.title;
            document.getElementById('player-container').innerHTML = `<video id="player" controls autoplay src="${input}" style="width:100%;height:100%"></video>`;
            currentPlayer.ref = document.getElementById('player');
        }
    }

    function extractYouTubeID(url) {
        const reg = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(reg);
        return match ? match[1] : (url.length === 11 ? url : null);
    }

    function addLapFromPlayer() {
        if (!currentPlayer.ref) return;
        let time = 0;
        try {
            time = (currentPlayer.type === 'youtube') ? currentPlayer.ref.getCurrentTime() : currentPlayer.ref.currentTime;
        } catch(e) { time = 0; }
        laps.push({ raw_time: parseFloat(time) || 0, opened: false });
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('laps-body');
        const offset = parseFloat(document.getElementById('correction').value) || 0;
        tbody.innerHTML = '';
        laps.forEach((lap, i) => {
            const tr = document.createElement('tr');
            if (lap.opened) tr.classList.add('opened');
            if (selectedIndex === i) tr.classList.add('active');
            
            // Захист від NaN
            let val = parseFloat(lap.raw_time);
            if (isNaN(val)) val = 0;
            const corrected = (val + offset).toFixed(2);
            
            tr.innerHTML = `<td>${i+1}</td><td>${corrected}с</td><td><button onclick="jump(${corrected}, ${i})">▶</button></td>`;
            tr.onclick = () => { selectedIndex = i; renderTable(); };
            tbody.appendChild(tr);
        });
    }

    function jump(sec, index) {
        if (!currentPlayer.ref) return;
        if (currentPlayer.type === 'youtube') currentPlayer.ref.seekTo(sec, true);
        else currentPlayer.ref.currentTime = sec;
        laps[index].opened = true;
        renderTable();
    }

    function exportSich() {
        const data = {
            video_url: document.getElementById('video-url').value,
            cor: document.getElementById('correction').value,
            laps: laps.map(l => ({ t: l.raw_time, o: l.opened }))
        };
        const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        const blob = new Blob([base64], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${currentPlayer.title}.sich`;
        a.click();
    }

    function importSich() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const rawData = decodeURIComponent(escape(atob(ev.target.result)));
                    const data = JSON.parse(rawData);
                    
                    if (data.video_url) handleSmartLoad(data.video_url);
                    document.getElementById('correction').value = data.cor || 0;
                    
                    // Універсальний парсинг міток (і для десктопа, і для вебу)
                    let loadedLaps = [];
                    let source = data.laps || data; // якщо це просто масив секунд з десктопа
                    
                    if (Array.isArray(source)) {
                        loadedLaps = source.map(item => {
                            let t = (typeof item === 'object') ? item.t : item;
                            return { raw_time: parseFloat(t) || 0, opened: item.o || false };
                        });
                    }
                    
                    laps = loadedLaps;
                    renderTable();
                } catch (err) { alert("Не вдалося прочитати файл. Перевірте формат."); }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }

    function deleteSelected() { if (selectedIndex !== null) { laps.splice(selectedIndex, 1); selectedIndex = null; renderTable(); } }
    function resetAll() { if (confirm("Очистити?")) { laps = []; renderTable(); } }
</script>
</body>
</html>
