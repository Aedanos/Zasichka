<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zasichka JS v0.9 (GitHub Edition)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #ffd700; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #video-section { flex: 1; background: #000; display: flex; flex-direction: column; }
        #player-container { width: 100%; flex-grow: 1; background: #000; }
        #sidebar { width: 400px; background: white; border-left: 2px solid #ddd; display: flex; flex-direction: column; padding: 15px; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .timer-display { font-family: 'Consolas', monospace; font-size: 3.2rem; text-align: center; color: var(--primary); margin: 10px 0; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 80px; gap: 10px; margin-bottom: 15px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-update { background: var(--accent); grid-column: span 2; }
        .btn-save { background: #ccffcc; }
        .btn-load { background: #d1e7ff; }
        .btn-reset { background: #eee; }
        .btn-delete { background: #ffcccc; }
        #table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 10px; border-bottom: 2px solid #ddd; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        tr:hover { background: #f0f7ff; cursor: pointer; }
        tr.active { background: #e3f2fd; font-weight: bold; }
        tr.opened td:nth-child(2) { color: #aaa; text-decoration: line-through; }
        .video-bar { padding: 12px; background: #1a1a1a; display: flex; gap: 10px; }
        .hotkey-hint { font-size: 11px; color: #888; text-align: center; padding-top: 10px; border-top: 1px solid #eee; margin-top: 10px; }
    </style>
</head>
<body>

<div id="video-section">
    <div id="player-container"><div id="player"></div></div>
    <div class="video-bar">
        <input type="text" id="video-url" style="flex-grow: 1;" placeholder="Вставте посилання на YouTube...">
        <button onclick="loadVideo()" style="background: white; min-width: 100px;">Завантажити</button>
    </div>
</div>

<div id="sidebar">
    <div class="timer-display" id="clock">0:00:00.00</div>
    
    <div class="settings-grid">
        <div>
            <label style="font-size: 11px; font-weight: bold;">Базовий URL:</label><br>
            <input type="text" id="base-url" style="width: 100%;" placeholder="Генерується автоматично">
        </div>
        <div>
            <label style="font-size: 11px; font-weight: bold;">Кор. (с):</label><br>
            <input type="number" id="correction" value="0" step="0.1" style="width: 100%;">
        </div>
        <button class="btn-update" onclick="renderTable()">ОНОВИТИ ТАБЛИЦЮ</button>
    </div>

    <div class="controls">
        <button class="btn-load" onclick="importCSV()">Відкрити CSV</button>
        <button class="btn-save" onclick="exportCSV()">Зберегти CSV</button>
        <button class="btn-delete" onclick="deleteSelected()">Видалити</button>
        <button class="btn-reset" onclick="resetTimer()">Скинути</button>
    </div>

    <div id="table-container">
        <table>
            <thead><tr><th>№</th><th>Секунди</th><th>Дія</th></tr></thead>
            <tbody id="laps-body"></tbody>
        </table>
    </div>
    <div class="hotkey-hint">F2: Старт/Стоп | F3: Мітка | Double-Click: Перейти</div>
</div>

<script>
    let player;
    let startTime = null;
    let elapsedBeforePause = 0;
    let running = false;
    let laps = [];
    let selectedIndex = null;

    // Ініціалізація YouTube API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%',
            videoId: '',
            playerVars: { 
                'autoplay': 1, 
                'rel': 0, 
                'enablejsapi': 1,
                'origin': window.location.origin
            }
        });
    }

    function extractVideoID(url) {
        const reg = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(reg);
        return match ? match[1] : (url.length === 11 ? url : null);
    }

    function loadVideo() {
        const val = document.getElementById('video-url').value.trim();
        const id = extractVideoID(val);
        if (id && player && player.loadVideoById) {
            player.loadVideoById(id);
            document.getElementById('base-url').value = `https://youtu.be/${id}?t=`;
        } else {
            alert("Невірне посилання YouTube.");
        }
    }

    // Логіка таймера
    function toggleTimer() {
        if (!running) { startTime = Date.now(); running = true; } 
        else { elapsedBeforePause += Date.now() - startTime; running = false; }
    }

    function addLap() {
        if (running || elapsedBeforePause > 0) {
            laps.push({ raw_time: getElapsedSeconds(), opened: false });
            renderTable();
            localStorage.setItem('zasichka_save', JSON.stringify(laps));
        }
    }

    function getElapsedSeconds() {
        return (running ? elapsedBeforePause + (Date.now() - startTime) : elapsedBeforePause) / 1000;
    }

    function updateClock() {
        const sec = getElapsedSeconds();
        const date = new Date(0);
        date.setSeconds(sec);
        const ms = Math.floor((sec % 1) * 100).toString().padStart(2, '0');
        document.getElementById('clock').innerText = date.toISOString().substr(11, 8) + "." + ms;
        requestAnimationFrame(updateClock);
    }

    function renderTable() {
        const tbody = document.getElementById('laps-body');
        const offset = parseFloat(document.getElementById('correction').value) || 0;
        tbody.innerHTML = '';
        laps.forEach((lap, i) => {
            const tr = document.createElement('tr');
            if (lap.opened) tr.classList.add('opened');
            if (selectedIndex === i) tr.classList.add('active');
            const corrected = Math.max(0, lap.raw_time + offset).toFixed(2);
            tr.innerHTML = `<td>${i+1}</td><td>${corrected}s</td><td><button onclick="jump(${corrected}, ${i})">▶</button></td>`;
            tr.onclick = () => { selectedIndex = i; renderTable(); };
            tr.ondblclick = () => jump(corrected, i);
            tbody.appendChild(tr);
        });
    }

    function jump(sec, index) {
        if (player && player.seekTo) {
            player.seekTo(sec, true);
            player.playVideo();
            laps[index].opened = true;
            renderTable();
        }
    }

    // Керування
    window.onkeydown = (e) => {
        if (e.key === 'F2') { e.preventDefault(); toggleTimer(); }
        if (e.key === 'F3') { e.preventDefault(); addLap(); }
    };

    function exportCSV() {
        const baseUrl = document.getElementById('base-url').value || "https://youtu.be/ID?t=";
        const offset = document.getElementById('correction').value;
        let csv = "\uFEFF### ZASICHKA_V0.5 ###;" + baseUrl + ";" + offset + "\n№;Секунди;Посилання;Відкрито;База\n";
        laps.forEach((l, i) => {
            const c = Math.max(0, l.raw_time + parseFloat(offset)).toFixed(2);
            csv += `${i+1};${c};${baseUrl}${c}s;${l.opened?'Так':'Ні'};${l.raw_time}\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "zasichka.csv"; a.click();
    }

    function importCSV() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                const lines = ev.target.result.split('\n');
                if (lines[0].includes('ZASICHKA')) {
                    const h = lines[0].split(';');
                    document.getElementById('base-url').value = h[1] || '';
                    document.getElementById('correction').value = h[2] || 0;
                    laps = [];
                    for(let i=2; i<lines.length; i++) {
                        const c = lines[i].split(';');
                        if(c.length >= 5) laps.push({raw_time: parseFloat(c[4]), opened: c[3]==='Так'});
                    }
                    renderTable();
                }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }

    function deleteSelected() { if(selectedIndex!==null) { laps.splice(selectedIndex,1); selectedIndex=null; renderTable(); } }
    function resetTimer() { if(confirm("Скинути?")) { laps=[]; elapsedBeforePause=0; running=false; renderTable(); } }

    window.onload = () => {
        const saved = localStorage.getItem('zasichka_save');
        if(saved) { laps = JSON.parse(saved); renderTable(); }
        updateClock();
    };
</script>
</body>
</html>