<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ó–∞—Å—ñ—á–∫–∞ v1.0</title>
    <style>
        :root { --primary: #2c3e50; --accent: #ffd700; --bg: #f4f7f6; --discord: #5865F2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #video-section { flex: 1; background: #000; display: flex; flex-direction: column; }
        #player-container { width: 100%; flex-grow: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        iframe, video { width: 100%; height: 100%; border: none; }
        
        #sidebar { width: 300px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; padding: 10px; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        
        .header-title { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; max-height: 3em; overflow-y: auto; line-height: 1.2; }
        .settings-grid { margin-bottom: 8px; background: #f9f9f9; padding: 6px; border-radius: 4px; }
        label { font-size: 9px; font-weight: bold; color: #666; display: block; margin-bottom: 2px; }
        input[type="number"], input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; width: 100%; box-sizing: border-box; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 5px; }
        button { padding: 6px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 10px; }
        
        .btn-main { background: var(--accent); grid-column: span 2; height: 40px; font-size: 12px; border-bottom: 3px solid #e6c300; }
        .btn-save { background: #ccffcc; }
        .btn-load { background: #d1e7ff; }
        .btn-reset { background: #eee; }
        .btn-delete { background: #ffcccc; }
        
        .btn-pc, .btn-discord, .btn-support { 
            grid-column: span 2; text-decoration: none; display: flex; align-items: center; 
            justify-content: center; border-radius: 4px; font-size: 10px; font-weight: bold; 
        }
        
        .btn-pc { background: #333; color: white; height: 25px; margin-top: 5px; font-size: 9px; }
        .btn-discord { background: var(--discord); color: white; height: 30px; margin-top: 2px; }
        .btn-support { background: #000; color: white; margin-top: 2px; height: 30px; }

        #table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 5px; border-bottom: 1px solid #ddd; z-index: 10; font-size: 9px; }
        td { padding: 4px; border-bottom: 1px solid #eee; text-align: center; }
        
        .col-id { width: 30px; }
        .col-time { width: 55px; font-family: monospace; }
        .col-desc { width: auto; }
        .col-act { width: 35px; }

        .note-input { border: none; background: transparent; font-size: 11px; width: 100%; text-align: left; }
        .note-input:focus { background: #fffde7; outline: 1px solid #ffd700; }

        tr.active { background: #e3f2fd !important; }
        tr.opened { opacity: 0.6; }
        .video-bar { padding: 8px; background: #1a1a1a; display: flex; gap: 5px; }
    </style>
</head>
<body>

<div id="video-section">
    <div id="player-container"><div style="color:white; font-size: 12px;">–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å OK</div></div>
    <div class="video-bar">
    <input type="file" id="local-file-input" accept="video/*" style="display: none;" onchange="handleLocalFile(this)">
    <button onclick="document.getElementById('local-file-input').click()" style="background:#eee; margin-right:5px; cursor:pointer;" title="–í—ñ–¥–∫—Ä–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª">üìÇ</button>
    
    <input type="text" id="video-url" placeholder="URL –≤—ñ–¥–µ–æ..." style="flex-grow:1; padding: 5px;">
    <button onclick="handleSmartLoad()" style="background:white; min-width: 50px;">OK</button>
</div>
</div>

<div id="sidebar">
    <div class="header-title" id="video-name-display">–ó–ê–°–Ü–ß–ö–ê</div>
    
    <div class="settings-grid">
        <label>–ö–û–†–ï–ö–¶–Ü–Ø (—Å–µ–∫):</label>
        <input type="number" id="correction" value="0" step="0.1" onchange="renderTable()">
    </div>

    <div class="controls">
        <button class="btn-main" onclick="addLapFromPlayer()">–ü–û–°–¢–ê–í–ò–¢–ò –ó–ê–°–Ü–ß–ö–£</button>
        <button class="btn-load" onclick="importSich()">–í–Ü–î–ö–†–ò–¢–ò</button>
        <button class="btn-save" onclick="exportSich()">–ó–ë–ï–†–ï–ì–¢–ò</button>
        <button class="btn-delete" onclick="deleteSelected()">–í–ò–î–ê–õ–ò–¢–ò</button>
        <button class="btn-reset" onclick="resetAll()">–û–ß–ò–°–¢–ò–¢–ò</button>
        
        <a href="https://github.com/Aedanos/Zasichka/releases/download/Zasichka/Zasichka_by_Aedan.v1.0.zip" class="btn-pc">üñ•Ô∏è –ó–ê–í–ê–ù–¢–ê–ñ–ò–¢–ò –í–ï–†–°–Ü–Æ –î–õ–Ø –ü–ö</a>
        <a href="https://discord.gg/YsvV9mK4Cy" target="_blank" class="btn-discord">üí¨ DISCORD –ö–ê–ù–ê–õ</a>
        <a href="https://send.monobank.ua/jar/3RqFJQ5akg" target="_blank" class="btn-support">üíôüíõ –ü–Ü–î–¢–†–ò–ú–ê–¢–ò</a>
    </div>

    <div id="table-container">
        <table>
            <thead>
                <tr>
                    <th class="col-id">‚Ññ</th>
                    <th class="col-time">–ß–∞—Å</th>
                    <th class="col-desc">–û–ø–∏—Å</th>
                    <th class="col-act"></th>
                </tr>
            </thead>
            <tbody id="laps-body"></tbody>
        </table>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let currentPlayer = { type: null, ref: null, title: "session" };
    let laps = [];
    let selectedIndex = null;

    function formatSimpleTime(totalSeconds) {
        const hrs = Math.floor(totalSeconds / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        const secs = Math.floor(totalSeconds % 60);
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function handleLocalFile(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        // –°—Ç–≤–æ—Ä—é—î–º–æ –±–µ–∑–ø–µ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª
        const fileURL = URL.createObjectURL(file);

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–∏–ø –ø–ª–µ—î—Ä–∞ —è–∫ 'direct' (—Ç–∞–∫ —Å–∞–º–æ —è–∫ –¥–ª—è mp4 –ø–æ—Å–∏–ª–∞–Ω—å)
        currentPlayer.type = 'direct';
        currentPlayer.title = file.name;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('video-name-display').innerText = currentPlayer.title;
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ HTML5 –≤—ñ–¥–µ–æ–ø–ª–µ—î—Ä
        document.getElementById('player-container').innerHTML = 
            `<video id="player" controls autoplay src="${fileURL}" style="width:100%;height:100%"></video>`;
        
        currentPlayer.ref = document.getElementById('player');
        
        // –û—á–∏—â–∞—î–º–æ —ñ–Ω–ø—É—Ç, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –≤–∏–±—Ä–∞—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ, —è–∫—â–æ —Ç—Ä–µ–±–∞
        inputElement.value = '';
    }
    
    function handleSmartLoad(url = null) {
        const input = url || document.getElementById('video-url').value.trim();
        if (!input) return;
        document.getElementById('video-url').value = input;
        document.getElementById('player-container').innerHTML = '<div id="player"></div>';
        
        const ytId = extractYouTubeID(input);
        if (ytId) {
            currentPlayer.type = 'youtube';
            currentPlayer.ref = new YT.Player('player', {
                height: '100%', width: '100%', videoId: ytId,
                playerVars: { 'autoplay': 1, 'rel': 0 },
                events: { 'onReady': (e) => { 
                    currentPlayer.title = e.target.getVideoData().title || "video";
                    document.getElementById('video-name-display').innerText = currentPlayer.title;
                }}
            });
        } else if (input.match(/\.(mp4|webm|ogg)$/i)) {
            currentPlayer.type = 'direct';
            currentPlayer.title = input.split('/').pop().split('?')[0];
            document.getElementById('video-name-display').innerText = currentPlayer.title;
            document.getElementById('player-container').innerHTML = `<video id="player" controls autoplay src="${input}" style="width:100%;height:100%"></video>`;
            currentPlayer.ref = document.getElementById('player');
        }
    }

    function extractYouTubeID(url) {
        const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
        return match ? match[1] : (url.length === 11 ? url : null);
    }

    function addLapFromPlayer() {
        if (!currentPlayer.ref) return;
        let time = 0;
        try {
            if (currentPlayer.type === 'youtube') time = currentPlayer.ref.getCurrentTime();
            else time = currentPlayer.ref.currentTime;
        } catch(e) { return; }
        
        laps.push({ raw_time: parseFloat(time) || 0, opened: false, note: "" });
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('laps-body');
        const offset = parseFloat(document.getElementById('correction').value) || 0;
        tbody.innerHTML = '';
        laps.forEach((lap, i) => {
            const tr = document.createElement('tr');
            if (lap.opened) tr.classList.add('opened');
            if (selectedIndex === i) tr.classList.add('active');
            const correctedTime = Math.max(0, lap.raw_time + offset);
            tr.innerHTML = `
                <td class="col-id">${i+1}</td>
                <td class="col-time">${formatSimpleTime(correctedTime)}</td>
                <td class="col-desc"><input type="text" class="note-input" value="${lap.note || ''}" onchange="updateNote(${i}, this.value)" placeholder="..."></td>
                <td class="col-act"><button onclick="smartAction(${correctedTime}, ${i})">‚ñ∂</button></td>
            `;
            tr.onclick = (e) => { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') { selectedIndex = i; renderTable(); } };
            tbody.appendChild(tr);
        });
    }

    function updateNote(index, val) { laps[index].note = val; }

    function smartAction(sec, index) {
        if (!currentPlayer.ref) return;
        if (selectedIndex === index) {
            if (currentPlayer.type === 'youtube') {
                const state = currentPlayer.ref.getPlayerState();
                if (state === 1) currentPlayer.ref.pauseVideo();
                else currentPlayer.ref.playVideo();
            } else {
                if (currentPlayer.ref.paused) currentPlayer.ref.play();
                else currentPlayer.ref.pause();
            }
        } else {
            if (currentPlayer.type === 'youtube') {
                currentPlayer.ref.seekTo(sec, true);
                currentPlayer.ref.playVideo();
            } else {
                currentPlayer.ref.currentTime = sec;
                currentPlayer.ref.play();
            }
            laps[index].opened = true;
            selectedIndex = index;
            renderTable();
        }
    }

    function exportSich() {
        const data = {
            video_url: document.getElementById('video-url').value,
            cor: document.getElementById('correction').value,
            laps: laps.map(l => ({ t: l.raw_time, o: l.opened, n: l.note }))
        };
        const jsonStr = JSON.stringify(data);
        const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
        const blob = new Blob([base64], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${(currentPlayer.title || 'session').replace(/[/\\?%*:|"<>]/g, '-')}.sich`;
        a.click();
    }

    function importSich() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.sich';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const base64 = ev.target.result.trim();
                    const decoded = decodeURIComponent(escape(atob(base64)));
                    const data = JSON.parse(decoded);
                    if (data.video_url) handleSmartLoad(data.video_url);
                    document.getElementById('correction').value = data.cor || 0;
                    let src = data.laps || data;
                    laps = Array.isArray(src) ? src.map(it => ({
                        raw_time: parseFloat(it.t || it) || 0,
                        opened: it.o || false,
                        note: it.n || ""
                    })) : [];
                    renderTable();
                } catch (err) { alert("–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É"); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function deleteSelected() { if (selectedIndex !== null) { laps.splice(selectedIndex, 1); selectedIndex = null; renderTable(); } }
    function resetAll() { if (confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ?")) { laps = []; document.getElementById('video-name-display').innerText = "–ó–ê–°–Ü–ß–ö–ê"; renderTable(); } }
</script>
</body>
</html>


